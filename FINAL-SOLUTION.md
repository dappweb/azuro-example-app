# GraphQL ä»£ç†æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

## âœ… é—®é¢˜å·²è§£å†³

æˆåŠŸå®ç°äº†åœ¨ Cloudflare Worker ç¯å¢ƒä¸­ä»£ç† Azuro SDK çš„ GraphQL è¯·æ±‚ï¼Œå®Œå…¨è§£å†³ CORS è·¨åŸŸé—®é¢˜ã€‚

## ğŸ¯ æœ€ç»ˆæ–¹æ¡ˆ

é‡‡ç”¨**æ„å»ºæ—¶ Worker Patch** æ–¹æ¡ˆï¼š

1. **å®¢æˆ·ç«¯ Fetch Polyfill** - æ‹¦æˆªæ‰€æœ‰ GraphQL è¯·æ±‚
2. **Worker Patch è„šæœ¬** - åœ¨æ„å»ºåè‡ªåŠ¨ä¿®æ”¹ OpenNext ç”Ÿæˆçš„ worker
3. **é€æ˜ä»£ç†** - åœ¨ Worker å±‚é¢è½¬å‘è¯·æ±‚åˆ°ç¬¬ä¸‰æ–¹ API

## ğŸ“ å…³é”®æ–‡ä»¶

### 1. `scripts/patch-worker.js`
æ„å»ºåè„šæœ¬ï¼Œè‡ªåŠ¨ä¿®æ”¹ `.open-next/worker.js`ï¼š
- åœ¨ Worker çš„ fetch å‡½æ•°å‰æ³¨å…¥ä»£ç†é€»è¾‘
- æ‹¦æˆª `/api/graphql-proxy` è¯·æ±‚
- è½¬å‘åˆ°çœŸå®çš„ GraphQL ç«¯ç‚¹

### 2. `src/helpers/fetchPolyfill.ts`
å®¢æˆ·ç«¯æ‹¦æˆªå™¨ï¼š
- æ‹¦æˆªåŒ…å« `thegraph`ã€`onchainfeed.org`ã€`azuro` çš„è¯·æ±‚
- é‡å®šå‘åˆ° `/api/graphql-proxy`
- æ·»åŠ  `X-Original-URL` å¤´

### 3. `src/compositions/Providers/Providers.tsx`
åˆå§‹åŒ– polyfillï¼š
- åœ¨æ¨¡å—åŠ è½½æ—¶ç«‹å³æ‰§è¡Œ
- ç¡®ä¿åœ¨ SDK å‘èµ·è¯·æ±‚å‰å®Œæˆåˆå§‹åŒ–

### 4. `package.json`
æ›´æ–°æ„å»ºè„šæœ¬ï¼š
```json
"cf:build": "npx @opennextjs/cloudflare build && node scripts/patch-worker.js"
```

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æ„å»ºé¡¹ç›®
```bash
npm run cf:build
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
âœ“ Compiled successfully
Worker saved in `.open-next\worker.js` ğŸš€
[Patch Worker] Starting to patch .open-next/worker.js...
[Patch Worker] Original worker size: 2646 bytes
[Patch Worker] âœ… Successfully patched worker!
[Patch Worker] New worker size: 5101 bytes
```

### 2. éƒ¨ç½²åˆ° Cloudflare
```bash
npm run cf:deploy
```

### 3. éªŒè¯éƒ¨ç½²
æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼š
1. Network æ ‡ç­¾
2. æŸ¥æ‰¾ `/api/graphql-proxy` è¯·æ±‚
3. ç¡®è®¤çŠ¶æ€ç  200
4. æŸ¥çœ‹ Response æ•°æ®

## ğŸ“Š å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯ (æµè§ˆå™¨)                                              â”‚
â”‚                                                              â”‚
â”‚  SDK è°ƒç”¨: fetch('https://thegraph-1.onchainfeed.org/...')  â”‚
â”‚                          â†“                                   â”‚
â”‚  Fetch Polyfill æ‹¦æˆª                                         â”‚
â”‚                          â†“                                   â”‚
â”‚  é‡å®šå‘åˆ°: /api/graphql-proxy                                â”‚
â”‚  æ·»åŠ å¤´: X-Original-URL                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare Worker (å·² Patch)                                 â”‚
â”‚                                                              â”‚
â”‚  æ£€æµ‹åˆ° /api/graphql-proxy è¯·æ±‚                              â”‚
â”‚                          â†“                                   â”‚
â”‚  è¯»å– X-Original-URL å¤´                                      â”‚
â”‚                          â†“                                   â”‚
â”‚  åœ¨æœåŠ¡ç«¯ fetch çœŸå® URL (æ—  CORS é™åˆ¶)                      â”‚
â”‚                          â†“                                   â”‚
â”‚  è½¬å‘å“åº”ç»™å®¢æˆ·ç«¯                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰æ–¹ GraphQL ç«¯ç‚¹                                          â”‚
â”‚                                                              â”‚
â”‚  https://thegraph-1.onchainfeed.org/                         â”‚
â”‚                          â†“                                   â”‚
â”‚  è¿”å› GraphQL æ•°æ®                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯ SDK                                                   â”‚
â”‚                                                              â”‚
â”‚  æ¥æ”¶æ•°æ®                                                    â”‚
â”‚  ç»§ç»­å¤„ç† (hooks, ç±»å‹æ˜ å°„ç­‰)                                â”‚
â”‚  å®Œå…¨é€æ˜ï¼ŒSDK ä¸çŸ¥é“è¢«ä»£ç†äº†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ ä¼˜åŠ¿

1. **âœ… å®Œå…¨å…¼å®¹** - Azuro SDK æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
2. **âœ… ç±»å‹å®‰å…¨** - ä¿ç•™æ‰€æœ‰ TypeScript ç±»å‹
3. **âœ… é›¶ä¾µå…¥** - ä¸ä¿®æ”¹ SDK æºç 
4. **âœ… è‡ªåŠ¨åŒ–** - æ„å»ºæ—¶è‡ªåŠ¨ patch
5. **âœ… é«˜æ€§èƒ½** - Worker å±‚é¢å¤„ç†ï¼Œé€Ÿåº¦å¿«
6. **âœ… æ˜“ç»´æŠ¤** - å‡çº§ SDK ä¸å—å½±å“

## ğŸ” è°ƒè¯•æ–¹æ³•

### æŸ¥çœ‹ Worker æ—¥å¿—

**æ–¹æ³• 1ï¼šä½¿ç”¨ wrangler tail**
```bash
wrangler tail
```

**æ–¹æ³• 2ï¼šCloudflare Dashboard**
1. ç™»å½• Cloudflare Dashboard
2. Workers & Pages â†’ azuro-example-app
3. Logs æ ‡ç­¾

### æŸ¥çœ‹å®¢æˆ·ç«¯æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
[Fetch Polyfill] âœ… Initialized - GraphQL requests will be proxied
[Fetch Polyfill] Proxied domains: ["thegraph", "onchainfeed.org", "azuro"]
[Fetch Polyfill] Intercepted request to: https://thegraph-1.onchainfeed.org/...
[Fetch Polyfill] Redirecting to /api/graphql-proxy
```

### æŸ¥çœ‹ Worker æ—¥å¿—

Worker æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š
```
[Worker Proxy] Intercepted request to /api/graphql-proxy
[Worker Proxy] Original URL: https://thegraph-1.onchainfeed.org/...
[Worker Proxy] Request body length: 856
[Worker Proxy] Response status: 200
[Worker Proxy] Response data received
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šä»ç„¶çœ‹åˆ° 530 é”™è¯¯

**åŸå› **ï¼šWorker patch æ²¡æœ‰ç”Ÿæ•ˆ

**è§£å†³**ï¼š
1. æ£€æŸ¥æ„å»ºæ—¥å¿—æ˜¯å¦æœ‰ `[Patch Worker] âœ… Successfully patched worker!`
2. é‡æ–°æ„å»ºï¼š`npm run cf:build`
3. é‡æ–°éƒ¨ç½²ï¼š`npm run cf:deploy`

### é—®é¢˜ 2ï¼šè¯·æ±‚ä»ç„¶ç›´è¿ç¬¬ä¸‰æ–¹

**åŸå› **ï¼šFetch polyfill æ²¡æœ‰åˆå§‹åŒ–

**è§£å†³**ï¼š
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. ç¡¬åˆ·æ–°é¡µé¢ (Ctrl+Shift+R)
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ polyfill åˆå§‹åŒ–æ—¥å¿—

### é—®é¢˜ 3ï¼šWorker æ—¥å¿—ä¸ºç©º

**åŸå› **ï¼šæ—¥å¿—çº§åˆ«è®¾ç½®é—®é¢˜

**è§£å†³**ï¼š
åœ¨ Cloudflare Dashboard ä¸­æ£€æŸ¥ Worker çš„æ—¥å¿—è®¾ç½®

## ğŸ“ é…ç½®é€‰é¡¹

### æ·»åŠ æ›´å¤šä»£ç†åŸŸå

ç¼–è¾‘ `src/helpers/fetchPolyfill.ts`:

```typescript
const PROXY_DOMAINS = [
  'thegraph',
  'onchainfeed.org',
  'azuro',
  'your-domain.com',  // æ·»åŠ æ–°åŸŸå
]
```

### ä¿®æ”¹ä»£ç†é€»è¾‘

ç¼–è¾‘ `scripts/patch-worker.js` ä¸­çš„ `handleGraphQLProxy` å‡½æ•°

## ğŸ”„ æ›´æ–°æµç¨‹

å½“éœ€è¦æ›´æ–°ä»£ç æ—¶ï¼š

```bash
# 1. ä¿®æ”¹ä»£ç 
# 2. é‡æ–°æ„å»ºï¼ˆä¼šè‡ªåŠ¨ patch workerï¼‰
npm run cf:build

# 3. éƒ¨ç½²
npm run cf:deploy
```

## âš ï¸ é‡è¦æç¤º

1. **æ¯æ¬¡æ„å»ºéƒ½ä¼šè‡ªåŠ¨ patch** - ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ
2. **å‡çº§ SDK ä¸å—å½±å“** - patch åªä¿®æ”¹ workerï¼Œä¸å½±å“ SDK
3. **æœ¬åœ°å¼€å‘** - ä½¿ç”¨ `npm run dev`ï¼Œä¸éœ€è¦ worker
4. **ç”Ÿäº§éƒ¨ç½²** - ä½¿ç”¨ `npm run cf:deploy`

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥æ„å»ºæ—¥å¿—
2. æ£€æŸ¥ Worker æ—¥å¿—
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°
4. æŸ¥çœ‹ Network è¯·æ±‚è¯¦æƒ…

## ğŸ‰ æˆåŠŸæ ‡å¿—

éƒ¨ç½²æˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š
- âœ… æµè§ˆå™¨æ§åˆ¶å°æœ‰ polyfill åˆå§‹åŒ–æ—¥å¿—
- âœ… Network ä¸­æœ‰ `/api/graphql-proxy` è¯·æ±‚
- âœ… è¯·æ±‚è¿”å› 200 çŠ¶æ€ç 
- âœ… Azuro SDK åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ²¡æœ‰ CORS é”™è¯¯
